<!-- Chat Component -->
<div class="chat-container">
  <!-- Chat Messages -->
  <div class="chat-messages" #chatMessages (scroll)="onScroll()">
    <!-- Load More History Button -->
    <div class="load-more-container" *ngIf="hasMoreHistory">
      <button class="load-more-btn" (click)="loadOlderMessages()">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />
        </svg>
        Fetch last 10 messages
      </button>
    </div>
    
    <div 
      *ngFor="let message of messages; let i = index" 
      class="message-wrapper"
      [ngClass]="{'user': message.sender === 'user', 'ai': message.sender === 'ai', 'system': message.sender === 'system'}">
      
      <div class="message-bubble">


        <!-- Message Content -->
        <div class="message-content">
          <div *ngIf="message.type === 'text'" [innerHTML]="formatMessage(message.content)"></div>
          
          <div *ngIf="message.type === 'command'" class="command-suggestion">
            <div class="command-header">
              <svg class="command-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7,2V13H10V22L17,10H13L17,2H7Z" />
              </svg>
              Suggested Command:
            </div>
            <div class="command-code">{{ message.content }}</div>
            <button class="execute-btn" (click)="executeCommand(message.content)">
              Execute Command
            </button>
          </div>

          <div *ngIf="message.type === 'analysis'" class="analysis-result">
            <div class="analysis-header">
              <svg class="analysis-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" />
              </svg>
              Analysis Result:
            </div>
            <div class="analysis-content" [innerHTML]="formatMessage(message.content)"></div>
          </div>
        </div>


      </div>
    </div>

    <!-- Typing Indicator -->
    <div *ngIf="isTyping" class="typing-indicator">
      <div class="typing-bubble">
        <div class="typing-dots">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>
    </div>

  </div>

  <!-- Scroll to Bottom Button -->
  <div class="scroll-to-bottom-container" *ngIf="showScrollToBottom">
    <button class="scroll-to-bottom-btn" (click)="scrollToBottom()" title="Scroll to bottom">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
      </svg>
    </button>
  </div>

  <!-- Chat Input -->
  <div class="chat-input-container">
    <div class="input-wrapper">
      <textarea 
        #messageInput
        class="chat-input"
        [(ngModel)]="currentMessage"
        (keydown)="onKeyDown($event)"
        (input)="onInput()"
        placeholder="Ask Chaos about penetration testing, vulnerabilities, or request command suggestions..."
        rows="1"
        maxlength="2000"></textarea>
      
      <div class="input-actions">
        <button class="send-btn" (click)="sendMessage()" [disabled]="!currentMessage.trim() || isTyping" title="Send Message">
          <svg viewBox="0 0 24 24" fill="currentColor" *ngIf="!isTyping">
            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
          </svg>
          <svg viewBox="0 0 24 24" fill="currentColor" *ngIf="isTyping">
            <path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2Z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Chat Controls -->
    <div class="chat-controls">
      <div class="controls-left">
        <button class="attach-btn" (click)="toggleAttachments()" title="Attach File">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.5,18A5.5,5.5 0 0,1 2,12.5A5.5,5.5 0 0,1 7.5,7H18A4,4 0 0,1 22,11A4,4 0 0,1 18,15H9.5A2.5,2.5 0 0,1 7,12.5A2.5,2.5 0 0,1 9.5,10H17V11.5H9.5A1,1 0 0,0 8.5,12.5A1,1 0 0,0 9.5,13.5H18A2.5,2.5 0 0,0 20.5,11A2.5,2.5 0 0,0 18,8.5H7.5A4,4 0 0,0 3.5,12.5A4,4 0 0,0 7.5,16.5H17V18H7.5Z" />
          </svg>
        </button>
        <button class="header-btn" (click)="clearChat()" title="New Chat">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
          </svg>
        </button>

      </div>
      <div class="controls-right">
        <select [(ngModel)]="selectedModel" (change)="onModelChange()" class="model-dropdown">
          <option *ngFor="let model of availableModels" [ngValue]="model">
            {{ model.name }}{{ model.tier === 'premium' ? ' (Premium)' : '' }}
          </option>
        </select>
        <span class="char-counter" [class.warning]="currentMessage.length > 1800">
          {{ currentMessage.length }}/2000
        </span>
      </div>
    </div>
  </div>

  <!-- Attachment Panel -->
  <div class="attachment-panel" *ngIf="showAttachments">
    <div class="attachment-options">
      <div class="attachment-option" (click)="attachFile('scan')">
        <svg class="option-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        </svg>
        <span class="option-text">Scan Results</span>
      </div>
      <div class="attachment-option" (click)="attachFile('log')">
        <svg class="option-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M8,12V14H16V12H8M8,16V18H13V16H8Z" />
        </svg>
        <span class="option-text">Log File</span>
      </div>
      <div class="attachment-option" (click)="attachFile('screenshot')">
        <svg class="option-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7Z" />
        </svg>
        <span class="option-text">Screenshot</span>
      </div>
    </div>
  </div>
</div>